pipeline {
     agent {
        docker {
            image 'docker:19.03'
            args '-v /var/run/docker.sock:/var/run/docker.sock'
        }
    }

    environment {
        SONARQUBE_URL = 'http://192.168.62.25:9000'
        PROJECT_KEY = 'app-de-test'
        SONAR_NODEJS_PATH = '/usr/bin/node'
        DOCKER_IMAGE = "my-app"
        DOCKERFILE_PATH= '/home/osboxes'
        
    }

    stages {
        stage('Checkout') {
            steps {
                checkout([$class: 'GitSCM', branches: [[name: '*/main']], userRemoteConfigs: [[url: 'https://github.com/hass2001/app_test.git']]])
            }
        }

        stage('Debug Path') {
            steps {
                sh 'ls -l /opt/sonar-scanner/bin'
                sh 'which sonar-scanner || echo "sonar-scanner not found"'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    withSonarQubeEnv('SonarQube') {
                        sh "/opt/sonar-scanner/bin/sonar-scanner"
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                sh "docker build -t ${DOCKER_IMAGE} ."
            }
        }

       

      

        
    }
}
